- name: Execute Terraform
  terraform:
    force_init: true
    backend_config:
      region: '{{ region }}'
      bucket: '{{ state_bucket }}'
      dynamodb_table: '{{ state_table }}'
    project_path: '{{ playbook_dir }}/terraform/'
    state: '{{ state }}'
    variables: {
      inventory_path: '{{ playbook_dir }}',
      group_vars_path: '{{ playbook_dir }}/group_vars/all/',
      hcloud_token: '{{ hcloud_token }}',
      hcloud_ssh_keys: '{{ hcloud_ssh_keys | to_json }}'
      hcloud_image: ubuntu-18.04
      hcloud_location: nbg1
      hcloud_master_count: 1
      hcloud_master_type: cx11
      hcloud_master_hostname_format: master-%d
      hcloud_worker_count: 2
      hcloud_worker_type: cx11
      hcloud_worker_hostname_format: worker-%d
      cloudflare_api_token: '{{ cloudflare_api_token }}'
      cloudflare_email: '{{ cloudflare_email }}'
    }
  register: terraform_result

- name: Store Terraform Output
  copy: "content={{ terraform_result.stdout }} dest={{ playbook_dir }}/terraform.stdout"
  delegate_to: localhost

- name: Remove Generated Inventory
  file:
    path: "{{ playbook_dir }}/production"
    state: absent
  when: state == "absent"

- name: Remove Generated Group Vars
  file:
    path: "{{ playbook_dir }}/group_vars/all/terraform_outputs.yaml"
    state: absent
  when: state == "absent"