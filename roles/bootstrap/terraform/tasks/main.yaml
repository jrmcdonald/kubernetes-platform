- name: Execute Terraform
  terraform:
    force_init: true
    backend_config:
      region: '{{ region }}'
      bucket: '{{ state_bucket }}'
      dynamodb_table: '{{ state_table }}'
    project_path: '{{ playbook_dir }}/terraform/'
    state: '{{ state }}'
    variables: { inventory_path: '{{ playbook_dir }}', group_vars_path: '{{ playbook_dir }}/group_vars/all/', hcloud_token: '{{ hcloud_token }}', cloudflare_api_token: '{{ cloudflare_api_token }}' }
  register: terraform_result

- name: Store Terraform Output
  copy: "content={{ terraform_result.stdout }} dest={{ playbook_dir }}/terraform.stdout"
  delegate_to: localhost

- name: Remove Generated Inventory
  file:
    path: "{{ playbook_dir }}/production"
    state: absent
  when: state == "absent"

- name: Remove Generated Group Vars
  file:
    path: "{{ playbook_dir }}/group_vars/all/terraform_outputs.yaml"
    state: absent
  when: state == "absent"